{% extends "base.html" %}

{% block title %}Travel Home{% endblock %}

{% block content %}
<div class="container py-5">
    <h1 class="mb-4 text-center fw-bold text-primary">Find Your Travel</h1>

    <form id="searchForm" method="post" class="row g-3 mb-5 bg-light p-4 rounded shadow-sm align-items-end">
        <!-- source -->
        <div class="position-relative col-md-4">
            <label for="source" class="form-label fw-semibold">Source</label>
            <input id="source" type="text" class="form-control" name="" placeholder="Enter source" autocomplete="off" required>
            <ul id="sourceSuggestions" class="list-group position-absolute w-100" style="z-index:1000;"></ul>
        </div>
        
        <!-- Destination -->
        <div class="position-relative col-md-4">
            <label for="destination" class="form-label fw-semibold">Destination</label>
            <input id="destination" type="text" class="form-control" name="destination" placeholder="Enter destination" autocomplete="off" required>
            <ul id="destinationSuggestions" class="list-group position-absolute w-100" style="z-index:1000;"></ul>
        </div>

        <!-- Date -->
        <div class="col-md-3">
            <label for="travelDate" class="form-label fw-semibold">Date</label>
            <input type="date" id="travelDate" class="form-control" name="travelDate" required>
        </div>

        <!-- Search Button -->
        <div class="col-md-1 d-grid">
            <button type="submit" class="btn btn-primary fw-semibold">Search</button>
        </div>
        <!-- Sorting Options -->
        <div class="col-12 d-flex flex-wrap gap-3 mt-3">
            <!-- Sort by type(Flight,Bus,Train) -->
            <select id="sortType" class="form-select w-auto" name="sortType">
                <option value="">Sort by Type</option>
                <option value="flight">Flight</option>
                <option value="bus">Bus</option>
                <option value="train">Train</option>
            </select>
            <!-- sortbyTime(Date) -->
            <select id="sortTime" class="form-select w-auto">
                <option value="">Sort by Time</option>
                <option value="asc">Earliest</option>
                <option value="desc">Latest</option>
            </select>
            <!-- Sort by Price(asc,desc) -->
            <select id="sortPrice" class="form-select w-auto">
                <option value="">Sort by Price</option>
                <option value="asc">Lowest</option>
                <option value="desc">Highest</option>
            </select>
        </div>
    </form>

    <!-- Results -->
    <div id="results" class="row g-4"></div>
</div>

{% endblock %}
{% block extra_js %}
<script>
    // global varaibles
    window.allTravels = []
    window.searchPlaces = []
    // Filtering based on differnt things(ex:source,destination) handled  by backend
    document.getElementById("searchForm").addEventListener("submit",async (e)=>{
        e.preventDefault()
        let source = document.getElementById("source").name
        let destination = document.getElementById("destination").name
        let dateAndTime = document.getElementById("travelDate").value;
        let type = document.getElementById("sortType").value
        let TimeSort = document.getElementById("sortTime").value
        let priceSort = document.getElementById("sortPrice").value;
        if(!source || !destination || !dateAndTime){
            alert("please enter the valid soruce and destination place")
            return
        }
        console.log(destination,source)
        const response = await fetch(`http://localhost:8000/travel/filter/?source=${source}&
destination=${destination}&date=${dateAndTime}&price=${priceSort}&datesort=${TimeSort}&type=${type}`)
        console.log(response , "this is the data")
        if(!response.ok){
            alert("error while getting the data")
            return
        }
        
        const transportData = await response.json();
        console.log(transportData , "this is the transport data")
        if(transportData){
           window.allTravels=transportData.data 
           renderResults(transportData.data)
        }
        


    })
    //  Filter 
    function applyFilters(){
        console.log("came to the filtereed thing")
        let filtered = [...window.allTravels]
        let type = document.getElementById("sortType").value
        let TimeSort = document.getElementById("sortTime").value
        let priceSort = document.getElementById("sortPrice").value;
        console.log(priceSort,"this is a price sort",TimeSort,priceSort)
        if(type){
            filtered = filtered.filter(e=>e.travelType.toLowerCase()===type.toLowerCase())
        }
        
        if (priceSort) {
            console.log(filtered)
            if(priceSort==="desc"){
                filtered = filtered.sort((a,b)=>b.price-a.price)
            }
            else{
                filtered = filtered.sort((a,b)=>a.price-b.price)
            }
        }
        
        
        if(TimeSort){
            if(TimeSort==="desc"){
                filtered = filtered.sort((a,b)=>new Date(b.bookingDateAndTime)-new Date(a.bookingDateAndTime))
            }
            else{
                filtered = filtered.sort((a,b)=>new Date(a.bookingDateAndTime)-new Date(b.bookingDateAndTime))
            }
        }
        renderResults(filtered)

    }
    // Render function to show the travel Cards
    function renderResults(data){
        console.log(data,"retuend data")
        const resultsDiv = document.getElementById("results");
        resultsDiv.innerHTML = "";

        if (data.length === 0) {
            resultsDiv.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-warning text-center">No results found.</div>
                </div>`;
            return;
        }

        data.forEach(item => {
        const date = new Date(item.bookingDateAndTime).toLocaleString();

        let transportIcon = "";
        if (item.travelType.toLowerCase() === "bus") {
            transportIcon = 'üöé'
        } else if (item.travelType.toLowerCase() === "train") {
            transportIcon = 'üöÜ';
        } else if (item.travelType.toLowerCase() === "flight") {
            transportIcon = '‚úàÔ∏è'
        }


        resultsDiv.innerHTML += `
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card h-100 shadow-lg border-0 rounded-4 overflow-hidden">
                    <div class="card-body d-flex flex-column">
                        
                        <!-- Transport Type -->
                        <div class="d-flex align-items-center mb-3">
                            ${transportIcon}
                            <span class="ms-2 badge bg-light text-dark px-3 py-2 rounded-pill fw-semibold">
                                ${item.travelType}
                            </span>
                        </div>

                        <!-- Travel Info -->
                        <div class="mb-3">
                            <p class="mb-1"><strong>From:</strong> ${item?.sourceplace?.placeName}</p>
                            <p class="mb-1"><strong>To:</strong> ${item?.destinationplace?.placeName}</p>
                            <p class="mb-1"><strong>Time:</strong> ${date}</p>
                            <p class="mb-1" id="travel-${item.travelId}"><strong>Available Seats:</strong> 
                                ${item.availableSeats}</p>
                            </p>
                        </div>

                        <!-- Price -->
                        <h5 class="text-success fw-bold mt-auto mb-3">‚Çπ${item.price}</h5>

                        <!-- Book Button -->
                        <button id="booking" class="btn btn-primary fw-semibold book-btn"
                            data-travel-id="${item.travelId}"
                            data-user-id="{% if user.is_authenticated %}{{ user.id }}{% endif %}"
                            data-price="${item.price}"
                            data-seats="${item.availableSeats}">
                            Book Now
                        </button>
                    </div>
                </div>
            </div>
                `;
            });
        }
    
    //  Api call to fecth the All Places at starting
    document.addEventListener("DOMContentLoaded",async (event) => {
        const response =  await fetch('http://localhost:8000/travel/places')
        if(!response.ok){
            alert('some error try again')
            return
        }
        const places = await response.json()
        if(places){
            window.searchPlaces=places.data
            setupAutocomplete("source","sourceSuggestions")
            setupAutocomplete("destination","destinationSuggestions")
        }
         

    });
    //  function to make setupPlaces Suggestions
    function setupAutocomplete(inputId, suggestionId) {
        const input = document.getElementById(inputId);
        const suggestionBox = document.getElementById(suggestionId);

        input.addEventListener("input", () => {
            const value = input.value.toLowerCase();
            suggestionBox.innerHTML = "";
            if (!value) return;

            const matches = window.searchPlaces.filter(place => 
                place.placeName.toLowerCase().includes(value)
            );

            matches.forEach(place => {
                const li = document.createElement("li");
                li.classList.add("list-group-item", "list-group-item-action");
                li.textContent = place.placeName;

                li.addEventListener("click", () => {
                    input.value = place.placeName;
                    input.name = place.id
                    suggestionBox.innerHTML = "";
                });

                suggestionBox.appendChild(li);
            });
        });

        document.addEventListener("click", (e) => {
            if (!input.contains(e.target) && !suggestionBox.contains(e.target)) {
                suggestionBox.innerHTML = "";
            }
        });
    }
    // handle the bookNow clicking
    document.getElementById("results").addEventListener("click", async (e) => {
    if(e.target.classList.contains("book-btn")){
        const travel_id = e.target.dataset.travelId;
        const user_id = e.target.dataset.userId;
        if(!user_id){
            alert("Please login to book.");
            return;
        }

        // Ask user for number of passengers
        let numberOfPassengers = prompt("Enter number of passengers:", "1");
        numberOfPassengers = parseInt(numberOfPassengers);
        if(isNaN(numberOfPassengers) || numberOfPassengers < 1){
            alert("Invalid number of passengers.");
            return;
        }

        const csrftoken ='{{ csrf_token }}';
        try {
            const response = await fetch('http://localhost:8000/booking/', {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrftoken
                },
                body: JSON.stringify({
                    numberOfSeatsBooked: numberOfPassengers,
                    travel_id: travel_id,
                    user_id: user_id,
                    bookingDate: new Date()
                })
            });

            if(!response.ok){
                alert("Booking failed!");
                return;
            }

            const data = await response.json();
            const availableSeats = document.getElementById(`travel-${Number(data.data.travel)}`);
            availableSeats.innerHTML=`
                <strong>Available Seats:</strong> 
                ${data.data.reaminingSeats}
            `;
            alert("Booking successful!");
        } catch (error) {
            alert(error.message);
        }
    }
});


    document.getElementById("sortType").addEventListener("change",applyFilters)
    document.getElementById("sortTime").addEventListener("change",applyFilters)
    document.getElementById("sortPrice").addEventListener("change",applyFilters)
    
</script>

{% endblock %}